# Task Templates
# All task instructions for debate simulation.
# Each function returns a complete task string with response format.


# Generate narrative background task.
def get_narrative_task() -> str:
    return """당신은 주안2 미추5구역에 사는 주민입니다. 주어진 페르소나를 바탕으로 자신 스스로 생각하는 형태로 이야기하세요.

1. 이 동네에 어떻게 오게 되었나요?
2. 재개발에 대해 어디서, 누구에게, 어떻게 들었나요?
3. '비례율', '분담금', '조합', '감정평가' 같은 재개발 용어를 들어본 적 있나요? 어느 정도 이해하고 있나요?
4. 재개발이 되면 당신의 생활은 어떻게 바뀔 것 같나요?
5. 구체적으로 어떤 일을 하고, 대략적인 하루 일과가 어떻게 되나요?
6. 이 동네에서 자주 만나는 이웃이 있나요? 혹은 동네 모임이나 반상회에 참여하나요?
7. 여러 사람이 모여서 의견이 갈릴 때 당신은 보통 어떻게 행동하나요?
8. 재개발 외에 요즘 가장 신경 쓰이는 생활 문제가 있나요? (예: 자녀교육, 건강, 경제적 문제 등)

응답 형식:
{"생각": "당신의 이야기"}"""


# Generate initial opinion task (MODE 4).
def get_initial_task() -> str:
    return """토의가 시작되기 전입니다. 아직 다른 주민의 의견을 듣지 않은 상태에서, 당신의 페르소나와 상황을 바탕으로 미추5구역 촉진계획 세부안에 대한 만족도와 그 이유를 이야기해주세요.

응답 형식:
{"입장": "매우불만족/불만족/만족/매우만족 중 택1", "생각": "당신의 이유와 생각"}"""


# Generate speaking turn task (MODE 1).
def get_speaking_task(round_num: int) -> str:
    return f"""현재 {round_num}라운드입니다. 당신의 발화 차례입니다.
토의 방식에 따라 발언해주세요.

응답 형식:
{{"발화": "당신의 의견", "지목": [{{"대상": "resident_XX", "입장": "공감/비판/인용/질문"}}] 또는 []}}

지목 규칙:
- 특정 주민의 의견을 언급할 때 해당 주민을 지목
- 공감: 상대 의견에 동의할 때
- 비판: 상대 의견에 반대하거나 문제점을 지적할 때
- 인용: 상대 의견을 참고하여 자기 주장을 할 때
- 질문: 상대 말이 이해가 안 되거나 궁금한 점이 있을 때
- 자신의 솔직한 반응에 맞는 유형을 선택하세요.
- 여러 주민 언급 시 여러 번 지목 가능. 지목 없이 의견만 말해도 됨 (지목: [])"""


# Generate thinking reaction task (MODE 2).
def get_think_task(listener_id: str, speaker_id: str, response_code: str, speech: str) -> str:
    speech_preview = speech[:100] if len(speech) > 100 else speech
    return f"""당신은 {listener_id}입니다. 대화기록에서 {listener_id}의 발언은 당신 자신의 발언입니다.

{speaker_id}의 발화(코드: {response_code}):
"{speech_preview}"

상대방이 왜 그렇게 말했는지, 그리고 당신({listener_id})은 어떻게 생각하는지 정리하세요.

응답 형식:
{{"상대의견": "{response_code}", "반응유형": "공감/비판/인용/질문/무시 중 택1", "생각": "당신의 생각"}}

반응유형 기준:
- 공감: 상대 의견에 동의할 때
- 비판: 상대 의견에 반대하거나 문제점을 지적할 때
- 인용: 상대 의견을 참고하여 자기 주장을 할 때
- 질문: 상대 말이 이해가 안 되거나 궁금한 점이 있을 때
- 무시: 관심 없거나 반응할 필요가 없다고 느낄 때
- 자신의 솔직한 반응에 맞는 유형을 선택하세요."""


# Generate round reflection task (MODE 3).
def get_reflection_task(resident_id: str, round_num: int) -> str:
    return f"""당신은 {resident_id}입니다. 대화기록에서 {resident_id}의 발언은 당신 자신의 발언입니다.

{round_num}라운드가 끝났습니다. 지금까지 들은 의견 중 가장 기억에 남는 것과 그 이유를 당신({resident_id})의 관점에서 정리하세요.

응답 형식:
{{"생각": "당신의 생각"}}"""


# Generate final speech task (debate format with stance).
def get_final_speech_task() -> str:
    return """토의가 모두 끝났습니다. 다른 주민들의 의견을 모두 들은 지금, 마지막으로 한마디 해주세요.
토의를 통해 느낀 점, 바뀐 생각, 유지하는 입장 등을 자유롭게 발언해주세요.
마지막 발언이므로 다른 주민을 지목하지 마세요.

응답 형식:
{"발화": "당신의 최종 발언"}"""


# =============================================================================
# Lv.1 Batch Tasks (single session, batch output)
# =============================================================================


def get_lv1_narrative_task() -> str:
    """Generate batch narrative task for all participants at once."""
    return """주안2동 미추5구역 주민들이 모여 재개발 계획안에 대해 이야기를 나눕니다.
참여자 목록의 각 주민 입장에서, 각 페르소나를 바탕으로 각자 스스로 생각하는 형태로 이야기하세요.

[질문]
1. 이 동네에 어떻게 오게 되었나요?
2. 재개발에 대해 어디서, 누구에게, 어떻게 들었나요?
3. '비례율', '분담금', '조합', '감정평가' 같은 재개발 용어를 들어본 적 있나요?
4. 재개발이 되면 당신의 생활은 어떻게 바뀔 것 같나요?
5. 이 동네에서 자주 만나는 이웃이 있나요?
6. 여러 사람이 모여서 의견이 갈릴 때 당신은 보통 어떻게 행동하나요?

각 주민의 페르소나(연령, 직업, 자가여부 등)에 맞게 자연스럽게 서술하세요.

응답 형식 (JSON 배열):
[
  {"resident_id": "resident_01", "서사": "..."},
  {"resident_id": "resident_02", "서사": "..."},
  ...
]"""


def get_lv1_initial_task() -> str:
    """Generate batch initial opinion task."""
    return """토의이 시작되기 전입니다. 각 주민의 페르소나와 서사를 바탕으로,
미추5구역 촉진계획 세부안에 대한 초기 입장을 작성하세요.

각 주민은 아직 다른 주민의 의견을 듣지 않은 상태입니다.
페르소나에 맞게 촉진계획 세부안에 대한 만족도를 선택하고 이유를 작성하세요.

응답 형식 (JSON 배열):
[
  {"resident_id": "resident_01", "입장": "매우불만족/불만족/만족/매우만족 중 택1", "생각": "..."},
  {"resident_id": "resident_02", "입장": "...", "생각": "..."},
  ...
]"""


def get_lv1_speaking_task(round_num: int) -> str:
    """Generate batch speaking task for one round."""
    return f"""{round_num}라운드입니다. 각 주민이 순서대로 발언합니다.

[라운드 {round_num} 지침]
- 1라운드: 간단한 자기소개 후 계획안에 대한 첫 의견
- 2라운드: 다른 주민 발언에 대한 반응, 질문, 동의/반대
- 3라운드: 토의을 통해 바뀐 생각이나 유지되는 입장 정리

각 주민은 자신의 페르소나와 초기 입장을 바탕으로 발언하세요.
다른 주민의 의견을 언급할 경우 지목(공감/비판/인용/질문)하세요.

응답 형식 (JSON 배열):
[
  {{"resident_id": "resident_01", "발화": "...", "지목": [{{"대상": "resident_XX", "입장": "공감/비판/인용/질문"}}] 또는 []}},
  {{"resident_id": "resident_02", "발화": "...", "지목": [...]}},
  ...
]"""


def get_lv1_final_speech_task() -> str:
    """Generate batch final speech task (debate format)."""
    return """토의가 모두 끝났습니다. 각 주민이 마지막으로 한마디씩 발언합니다.

각 주민은 토의를 통해 느낀 점, 바뀐 생각, 유지하는 입장 등을 자유롭게 발언해주세요.
마지막 발언이므로 다른 주민을 지목하지 마세요.

응답 형식 (JSON 배열):
[
  {"resident_id": "resident_01", "발화": "..."},
  {"resident_id": "resident_02", "발화": "..."},
  ...
]"""


# =============================================================================
# Planner & Vote Tasks
# =============================================================================


def get_planner_task() -> str:
    """Generate urban planner synthesis task."""
    return """주민 토의 전문과 최종 의견을 분석하여 다음을 수행하세요:

1. 토의에서 나타난 논쟁요소를 주제별로 카테고리화하세요.
2. 각 논쟁요소에 대해 "주민 의견"과 "계획안 내용/지역 맥락에서 추론되는 계획안의 설계 논리"를 각각 정리하세요. 토의에서 다뤄지지 않은 관점도 계획안에서 찾아 제시하세요.
3. 각 논쟁요소에 대해 실현 가능한 절충안을 제시하세요. 법적 요건, 사업 수지, 기술적 제약 등 실현 가능성을 반드시 고려하고, 계획안의 기존 수치를 변경할 경우 그에 따른 영향(trade-off)을 명시하세요.
4. 모든 절충안을 통합한 최종합의문을 작성하세요.

응답 형식:
{"논쟁요소": [{"주제": "주제명", "주민의견": "주민 의견 요약", "계획안분석": "계획안의 설계 논리와 근거", "절충안": "구체적 절충 제안과 trade-off"}], "최종합의문": "전체 합의 문서"}"""


def get_vote_task() -> str:
    """Generate resident vote task for Lv.2~4."""
    return """도시계획가가 토의 내용을 분석하여 절충안을 제시했습니다.
대화기록에 추가된 도시계획가의 최종합의문을 읽고, 절충안에 대한 만족도를 평가해주세요.

응답 형식:
{"입장": "매우불만족/불만족/만족/매우만족 중 택1", "이유": "만족도 평가 이유"}"""


def get_lv1_vote_task() -> str:
    """Generate batch vote task for Lv.1."""
    return """도시계획가가 토의 내용을 분석하여 절충안을 제시했습니다.
위의 도시계획가 합의문을 읽고, 각 주민의 입장에서 절충안에 대한 만족도를 평가하세요.

응답 형식 (JSON 배열):
[
  {"resident_id": "resident_01", "입장": "매우불만족/불만족/만족/매우만족 중 택1", "이유": "..."},
  {"resident_id": "resident_02", "입장": "...", "이유": "..."},
  ...
]"""
